# 9.1 真实操作系统内存使用情况

（00:00 - 03:32 在对前两个lab提问，与内容无关故跳过）

今天课程的内容是中断。但是在具体介绍中断之前，我想先回顾一下上周一些有趣的内容。因为上周的课程主要是讲内存，我们收到了很多内存相关的问题。我想先讨论一下内存是如何被真实的操作系统（而不是像XV6这样的教学操作系统）所使用。

下图是一台Athena计算机（注，MIT内部共享使用的计算机）的top指令输出。如果你查看Mem这一行，

![](<../.gitbook/assets/image (851).png>)

首先是计算机中总共有多少内存（33048332），如果你再往后看的话，你会发现大部分内存都被使用了（4214604 + 26988148）。但是大部分内存并没有被应用程序所使用，而是被buff/cache用掉了。这在一个操作系统中还挺常见的，因为我们不想让物理内存就在那闲置着，我们想让物理内存被用起来，所以这里大块的内存被用作buff/cache。可以看到还有一小块内存是空闲的（1845580），但是并不多。

以上是一个非常常见的场景，大部分操作系统运行时几乎没有任何空闲的内存。这意味着，如果应用程序或者内核需要使用新的内存，那么我们需要丢弃一些已有的内容。现在的空闲内存（free）或许足够几个page用，但是在某个时间点如果需要大量内存的话，要么是从应用程序，要么是从buffer/cache中，需要撤回已经使用的一部分内存。所以，当内核在分配内存的时候，通常都不是一个低成本的操作，因为并不总是有足够的可用内存，为了分配内存需要先撤回一些内存。

另外，我这里将top的输出按照RES进行了排序。如果你查看输出的每一行，VIRT表示的是虚拟内存地址空间的大小，RES是实际使用的内存数量。从这里可以看出，实际使用的内存数量远小于地址空间的大小。所以，我们上节课讨论的基于虚拟内存和page fault提供的非常酷的功能在这都有使用，比如说demand paging。

有关这台机器的其它信息还有：

* 即使它有103个用户登录进来了，它的负载还是很低
* 它有许多许多的进程
* 这台机器已经运行了249天，我们的XV6系统或许运行不了这么久

这里想传达的信息：大部分内存都被使用了，并且RES内存远小于VIRT内存。



------



# **9.1 真实操作系统内存使用情况**

在正式介绍**中断**之前，教授首先回顾了真实操作系统中内存的实际使用情况。对比**XV6**等教学操作系统，现实中操作系统的内存管理更复杂，涉及到多种优化技术。以下是MIT的一台**Athena计算机**的内存使用情况分析（通过`top`命令查看）：

------

### **1. 内存使用情况概览**

**下图展示了Athena计算机的`top`输出：**

输出中显示了操作系统如何分配内存，包含以下几个关键数据：

- **物理内存总量**：该机器的内存总量为33,048,332 KB。
- ==实际分配内存：内存分配分为以下几部分：==
  - **Used（4214604 + 26988148 KB）**：被使用的物理内存总量，其中包括应用程序使用的内存和缓存。
  - **Free（1845580 KB）**：真正闲置的内存量。

在真实操作系统中，闲置的内存并不多，因为操作系统会尽量利用可用内存资源。具体来说，大部分内存会被分配给**buffer/cache**，作为缓存资源使用。

### **2. 缓存与内存回收**

- ==操作系统会尽量利用物理内存，将其用于**buffer/cache**等缓存区域，避免资源闲置，提高系统性能。=
- **分配内存的代价**：当内存需求增加时，系统需要将部分缓存或应用程序内存**撤回**（即释放），以腾出空间。尤其是内存需求大的场景下，这一过程成本更高，因为撤回和分配内存可能涉及写回数据或清除缓存。

### **3. 虚拟内存与RES内存**

- **VIRT（虚拟内存地址空间）**：虚拟内存地址空间的大小，通常显著大于实际的物理内存。
- ==**RES（常驻内存）**：程序实际使用的物理内存。通过对比VIRT和RES，可以看出大部分分配的虚拟内存并未占用实际物理内存。==

==这一现象正是利用了**虚拟内存和page fault机制**，结合**demand paging**技术，内存只在实际访问时分配给物理内存页，从而实现内存资源的高效利用。==

### **4. 机器运行情况**

教授指出，这台机器的其他特征包括：

- **多用户和多进程**：该计算机支持103个用户登录，并运行着大量进程。
- **长期稳定运行**：已稳定运行了249天，远超XV6等教学操作系统的设计时长。

### **总结**

从这台Athena计算机的内存使用情况可以看出，**真实操作系统会充分利用虚拟内存和缓存机制来优化内存管理**，实现更高的资源利用率和稳定性。而通过**buffer/cache**区域的动态管理，操作系统能够在保持较高性能的同时，将空闲内存最小化。这也展示了虚拟内存技术在实际操作系统中的关键作用，通过**demand paging**等功能实现动态、高效的内存资源管理。
